/*
var _0x2950=["\x44\x4F\x4D\x43\x6F\x6E\x74\x65\x6E\x74\x4C\x6F\x61\x64\x65\x64",
"\x61\x64\x64\x45\x76\x65\x6E\x74\x4C\x69\x73\x74\x65\x6E\x65\x72",
"\x63\x6C\x69\x63\x6B","\x62\x6C\x6F\x71\x75\x73\x65\x72",
"\x67\x65\x74\x45\x6C\x65\x6D\x65\x6E\x74\x42\x79\x49\x64",
"\x62\x6F\x64\x79\x2D\x74\x61\x62\x6C\x61","\x69\x6E\x6E\x65\x72\x48\x54\x4D\x4C"
,"","\x73\x74\x61\x74\x75\x73","\x69\x6E\x73\x65\x72\x74\x52\x6F\x77",
"\x0D\x0A\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x3C\x74\x64\x3E\x3C\x2F\x74\x64\x3E\x0D\x0A\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x3C\x74\x64\x3E",
"\x69\x64","\x3C\x2F\x74\x64\x3E\x0D\x0A\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x3C\x74\x64\x3E","\x61\x70\x79\x4E\x6F\x6D\x50\x65\x72\x73\x6F\x6E\x61",
"\x6E\x6F\x6D\x62\x72\x65","\x65\x73\x74\x61\x42\x6C\x6F\x71\x75\x65\x61\x64\x6F\x53\x74\x72",
"\x3C\x2F\x74\x64\x3E\x0D\x0A\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20",
"\x69\x6E\x70\x75\x74","\x63\x72\x65\x61\x74\x65\x45\x6C\x65\x6D\x65\x6E\x74",
"\x74\x79\x70\x65","\x63\x68\x65\x63\x6B\x62\x6F\x78",
"\x63\x68\x6B\x2D\x73\x65\x6C\x65\x63\x63\x69\x6F\x6E\x61\x72","\x61\x64\x64",
"\x63\x6C\x61\x73\x73\x4C\x69\x73\x74","\x61\x70\x70\x65\x6E\x64\x43\x68\x69\x6C\x64",
"\x63\x68\x69\x6C\x64\x72\x65\x6E","\x66\x6F\x72\x45\x61\x63\x68","\x75\x73\x75\x61\x72\x69\x6F\x73",
"\x74\x68\x65\x6E","\x6A\x73\x6F\x6E","\x4E\x6F\x20\x73\x65\x20\x70\x75\x64\x6F\x20\x63\x61\x72\x67\x61\x72\x20\x6C\x6F\x73\x20\x75\x73\x75\x61\x72\x69\x6F\x73\x20",
"\x73\x74\x61\x74\x75\x73\x54\x65\x78\x74","\x6C\x6F\x67",
"\x2F\x53\x65\x67\x75\x72\x69\x64\x61\x64\x2F\x4A\x73\x6F\x6E\x55\x73\x75\x61\x72\x69\x6F\x73",
"\x50\x4F\x53\x54","\x66\x69\x6E\x61\x6C\x69\x7A\x61\x64\x6F",
"\x4F\x63\x75\x72\x72\x69\x6F\x20\x75\x6E\x20\x65\x72\x72\x6F\x72\x20\x61\x6C\x20\x72\x65\x61\x6C\x69\x7A\x61\x72\x20\x6C\x61\x20\x61\x63\x63\x69\xF3\x6E","\x2F\x53\x65\x67\x75\x72\x69\x64\x61\x64\x2F\x41\x63\x63\x69\x6F\x6E\x55\x73\x75\x61\x72\x69\x6F\x73","\x50\x55\x54","\x61\x70\x70\x6C\x69\x63\x61\x74\x69\x6F\x6E\x2F\x6A\x73\x6F\x6E",
"\x73\x74\x72\x69\x6E\x67\x69\x66\x79","\x74\x72","\x63\x6C\x6F\x73\x65\x73\x74","\x74\x65\x78\x74","\x65\x71","\x74\x64","\x66\x69\x6E\x64",
"\x70\x75\x73\x68","\x65\x61\x63\x68","\x23\x62\x6F\x64\x79\x2D\x74\x61\x62\x6C\x61\x20\x74\x72\x20\x74\x64\x20\x69\x6E\x70\x75\x74\x5B\x74\x79\x70\x65\x3D\x22\x63\x68\x65\x63\x6B\x62\x6F\x78\x22\x5D\x3A\x63\x68\x65\x63\x6B\x65\x64"];
document[_0x2950[1]](_0x2950[0],()=>{ActualizarTabla()});document[_0x2950[4]](_0x2950[3])[_0x2950[1]](_0x2950[2],()=>{let _0x5304x1=ObtenerUsuariosSeleccionados();BloqDesbloqUsuarios(_0x5304x1)});function ActualizarTabla(){const _0x5304x3=document[_0x2950[4]](_0x2950[5]);_0x5304x3[_0x2950[6]]= _0x2950[7];fetch(_0x2950[33],{method:_0x2950[34]})[_0x2950[28]]((_0x5304x4)=>{if(_0x5304x4[_0x2950[8]]=== 200){_0x5304x4[_0x2950[29]]()[_0x2950[28]]((_0x5304x5)=>{_0x5304x5[_0x2950[27]][_0x2950[26]]((_0x5304x6)=>{let _0x5304x7=_0x5304x3[_0x2950[9]]();_0x5304x7[_0x2950[6]]= `${_0x2950[10]}${_0x5304x6[_0x2950[11]]}${_0x2950[12]}${_0x5304x6[_0x2950[13]]}${_0x2950[12]}${_0x5304x6[_0x2950[14]]}${_0x2950[12]}${_0x5304x6[_0x2950[15]]}${_0x2950[16]}`;let _0x5304x8=document[_0x2950[18]](_0x2950[17]);_0x5304x8[_0x2950[19]]= _0x2950[20];_0x5304x8[_0x2950[23]][_0x2950[22]](_0x2950[21]);_0x5304x7[_0x2950[25]][0][_0x2950[24]](_0x5304x8)})})}else {console[_0x2950[32]](`${_0x2950[30]}${_0x5304x4[_0x2950[31]]}${_0x2950[7]}`)}})}const BloqDesbloqUsuarios=(_0x5304xa)=>{fetch(_0x2950[37],{method:_0x2950[38],headers:{'\x43\x6F\x6E\x74\x65\x6E\x74\x2D\x54\x79\x70\x65':_0x2950[39]},body:JSON[_0x2950[40]](_0x5304xa)})[_0x2950[28]]((_0x5304x4)=>{return _0x5304x4[_0x2950[29]]()})[_0x2950[28]]((_0x5304x5)=>{if(_0x5304x5[_0x2950[35]]){ActualizarTabla()}else {alert(_0x2950[36])}})};function ObtenerUsuariosSeleccionados(){let _0x5304xa=[];$(_0x2950[49])[_0x2950[48]](function(){let _0x5304x7=$(this)[_0x2950[42]](_0x2950[41]);let _0x5304x6={Id:_0x5304x7[_0x2950[46]](_0x2950[45])[_0x2950[44]](1)[_0x2950[43]](),Empleado:_0x5304x7[_0x2950[46]](_0x2950[45])[_0x2950[44]](2)[_0x2950[43]]()};_0x5304xa[_0x2950[47]](_0x5304x6)});return _0x5304xa}
*/


document.addEventListener('DOMContentLoaded', () => {
    ActualizarTabla();
});

document.getElementById('bloquser').addEventListener('click', () => {
    let usuariosSeleccionados = ObtenerUsuariosSeleccionados();

    BloqDesbloqUsuarios(usuariosSeleccionados);
});

function ActualizarTabla() {

    const tabla = document.getElementById('body-tabla');
    tabla.innerHTML = '';

    fetch('/Seguridad/JsonUsuarios', { method: 'POST' })
        .then(response => {
            if (response.status === 200) {
                response.json()
                    .then(json => {
                    json.usuarios.forEach((usuario) => {
                        let row = tabla.insertRow();

                    row.innerHTML = `
                    <td></td>
                    <td>${usuario.id}</td>
                    <td>${usuario.apyNomPersona}</td>
                    <td>${usuario.nombre}</td>
                    <td>${usuario.estaBloqueadoStr}</td>
                    `

                            let check = document.createElement('input');
                            check.type = 'checkbox';
                            check.classList.add('chk-seleccionar');

                            row.children[0].appendChild(check);
                        });
                    })
            }
            else {
                console.log(`No se pudo cargar los usuarios ${response.statusText}`);
            }
        })
}


const BloqDesbloqUsuarios = (usuarios) => {

    fetch('/Seguridad/AccionUsuarios', {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json'
        },
        body:JSON.stringify(usuarios)
    })
    .then(response => response.json())
    .then(json => {
        if (json.finalizado){
            Swal.fire(
                'Exito',
                'La operación se realizo exitosamente.',
                'success'
            )
            ActualizarTabla();
        }else{
            alert("Ocurrio un error al realizar la acción");
        }
    })
}

function ObtenerUsuariosSeleccionados() {
    let usuarios = [];

    $('#body-tabla tr td input[type="checkbox"]:checked').each(function () {
        let row = $(this).closest('tr');

        let bloqueo = row.find('td').eq(4).text() === 'SI' ? true : false;

        let usuario = {
            Id: row.find('td').eq(1).text(),
            Empleado: row.find('td').eq(2).text(),
            EstaBloqueado: bloqueo
        }

        usuarios.push(usuario);
    });

    return usuarios;
}